# Project Design: Contextware (Skill)

## 1. Overview
**Contextware** is a Gemini CLI skill that provides persistent, semantic memory for software development. It enables the agent to remember project decisions, user preferences, and high-level code purpose across sessions.

## 2. Architecture
The system is managed via **`uv`** and runs entirely locally.

*   **Dependency Management:** `pyproject.toml` (managed by `uv`).
*   **Database:** `lancedb` (Local Vector DB).
*   **Embeddings:** `fastembed` (Local, CPU-friendly embeddings).
*   **Storage Path:** `<project_root>/contextware_data/`.
*   **Execution:** All background tasks and scripts run via `uv run`.

## 3. Data Collections

### A. `facts` (The "Hippocampus")
*   **Source:** Explicitly saved by the agent using `save_memory`.
*   **Content:** Concise statements (e.g., "User prefers Pytest").
*   **Used For:** Precise retrieval of constraints and preferences.

### B. `episodes` (The "Black Box")
*   **Source:** Explicitly saved by the agent to record outcomes of tasks.
*   **Content:**
    *   `goal`: The objective being pursued.
    *   `result`: `success` | `failure` | `partial`.
    *   `category`: `shell` | `git` | `code` | `test` | etc.
    *   `summary`: Narrative of actions taken and lessons learned.
*   **Used For:** Preventing infinite loops and repeating past mistakes.

### C. `logs` (The "Diary")
*   **Source:** Automatically logged user/agent messages.
*   **Content:** Raw text chunks.
*   **Used For:** Broad context retrieval (RAG).

### D. `code_index` (The "Map")
*   **Source:** Generated by background **headless Gemini** instances.
*   **Content:**
    *   `file_path`: Primary Key.
    *   `summary`: High-level purpose.
    *   `symbols`: List of key classes/functions (purely generative).
    *   `mtime`: Last modified timestamp for freshness checking.
*   **Used For:** Semantic search for files and structural overview.

## 4. Workflows

### Memory Capture
1.  **Fact Capture:** The agent identifies a persistent preference or constraint and executes `uv run scripts/save_fact.py --type fact "<fact>"`.
2.  **Episode Capture (Black Box):** When a logical task or significant command finishes, the agent records the outcome:
    `uv run scripts/save_fact.py --type episode --goal "..." --result "success|failure" --category "..." "Summary of actions taken"`.
3.  **Storage:** `save_fact.py` embeds the content (including metadata for episodes) and saves it to the relevant collection.

### Codebase Indexing (Background)
1.  Agent modifies a file (e.g., `src/app.py`).
2.  Agent triggers a background process: `uv run scripts/index_file.py src/app.py &`.
3.  `index_file.py` spawns a **headless Gemini** instance using the `gemini` executable from PATH.
4.  Headless Gemini:
    *   Reads the file.
    *   Generates a JSON containing a `summary` and a list of `symbols`.
    *   Writes the result to the `code_index` collection via the storage script.

### Project Crawl (Full Index)
1.  **Action:** The agent executes `uv run scripts/crawl_project.py`.
2.  **Process:** This script spawns a **single headless Gemini agent** with the goal: "Traverse the project, read all source files, and update the `code_index` for each."
3.  The headless agent autonomously walks the directory tree, summarizing files and updating the DB as it goes.

### Retrieval (RAG)
1.  User asks: "Where do we define the data models?" or agent checks: "Have I tried this fix before?"
2.  **Action:** Agent executes `uv run scripts/recall.py --query "..." --scope "all"|"code"|"memory"|"episodes"`.
3.  The system:
    *   Searches relevant collections via vector similarity.
    *   **For Episodes:** Returns structured records including `[RESULT] [CATEGORY] Goal: ... | Summary: ...`.
    *   **For Code:** Checks `mtime`. If stale, returns: `"[STALE] File changed recently. Please read directly."`
    *   **If mode="summary" (Default):** Returns the summary and symbol list.
    *   **If mode="exact":** Concatenates all relevant files (determined by vector similarity) and outputs them.
        *   *Constraint:* If a file is too large, the system instructs the agent to read portions of it itself.
4.  **Agent Action:** If info is missing or stale, the agent falls back to its native `read_file` tool to get full content.

## 5. Scripts (CLI Interface)

The agent interacts with the Contextware skill by executing scripts via `run_shell_command`:

1.  `uv run scripts/save_fact.py --type fact|episode [--goal G] [--result R] [--category C] "<content>"`: Saves a semantic fact or episodic outcome.
2.  `uv run scripts/crawl_project.py`: Starts a full background codebase index.
3.  `uv run scripts/recall.py --query "<query>" --scope "all"|"code"|"memory"|"episodes" --mode "summary"|"exact"`: Retrieves relevant context.
4.  `uv run scripts/index_file.py <file_path> &`: Indexes a specific file in the background.
