# Project Design: Contextware (Skill)

## 1. Overview
**Contextware** is a Gemini CLI skill that provides persistent, semantic memory for software development. It enables the agent to remember project decisions, user preferences, and high-level code purpose across sessions.

## 2. Architecture
The system is managed via **`uv`** and runs entirely locally.

*   **Dependency Management:** `pyproject.toml` (managed by `uv`).
*   **Database:** `lancedb` (Local Vector DB).
*   **Embeddings:** `fastembed` (Local, CPU-friendly embeddings).
*   **Storage Path:** `<project_root>/contextware_data/`.
*   **Execution:** All background tasks and scripts run via `uv run`.

## 3. Data Collections

### A. `facts` (The "Hippocampus")
*   **Source:** Explicitly saved by the agent using `save_memory`.
*   **Content:** Concise statements (e.g., "User prefers Pytest").
*   **Used For:** Precise retrieval of constraints and preferences.

### B. `logs` (The "Diary")
*   **Source:** Automatically logged user/agent messages.
*   **Content:** Raw text chunks.
*   **Used For:** Broad context retrieval (RAG).

### C. `code_index` (The "Map")
*   **Source:** Generated by background **headless Gemini** instances.
*   **Content:**
    *   `file_path`: Primary Key.
    *   `summary`: High-level purpose.
    *   `symbols`: List of key classes/functions (purely generative).
    *   `mtime`: Last modified timestamp for freshness checking.
*   **Used For:** Semantic search for files and structural overview.

## 4. Workflows

### Memory Capture
1.  **Trigger:** The agent continuously analyzes the conversation to identify important facts, user preferences, architectural decisions, or constraints that are likely to be relevant in future sessions.
2.  **Action:** When such a fact is identified, the agent proactively executes `uv run scripts/save_fact.py "<fact>"`.
3.  **Storage:** `save_fact.py` embeds and saves the fact to the `facts` collection.

### Codebase Indexing (Background)
1.  Agent modifies a file (e.g., `src/app.py`).
2.  Agent triggers a background process: `uv run scripts/index_file.py src/app.py &`.
3.  `index_file.py` spawns a **headless Gemini** instance using the `gemini` executable from PATH.
4.  Headless Gemini:
    *   Reads the file.
    *   Generates a JSON containing a `summary` and a list of `symbols`.
    *   Writes the result to the `code_index` collection via the storage script.

### Project Crawl (Full Index)
1.  **Action:** The agent executes `uv run scripts/crawl_project.py`.
2.  **Process:** This script spawns a **single headless Gemini agent** with the goal: "Traverse the project, read all source files, and update the `code_index` for each."
3.  The headless agent autonomously walks the directory tree, summarizing files and updating the DB as it goes.

### Retrieval (RAG)
1.  User asks: "Where do we define the data models?"
2.  **Action:** Agent executes `uv run scripts/recall.py --query "data models" --scope "codebase" --mode "summary"|"exact"`.
3.  The system:
    *   Searches `code_index` via vector similarity.
    *   Checks `mtime`. If stale, returns: `"[STALE] File changed recently. Please read directly."`
    *   **If mode="summary" (Default):** Returns the summary and symbol list.
    *   **If mode="exact":** Concatenates all relevant files (determined by vector similarity) and outputs them.
        *   *Constraint:* If a file is too large, the system instructs the agent to read portions of it itself.
4.  **Agent Action:** If info is missing or stale, the agent falls back to its native `read_file` tool to get full content.

## 5. Scripts (CLI Interface)

The agent interacts with the Contextware skill by executing scripts via `run_shell_command`:

1.  `uv run scripts/save_fact.py "<fact>"`: Saves a semantic fact or preference.
2.  `uv run scripts/crawl_project.py`: Starts a full background codebase index.
3.  `uv run scripts/recall.py --query "<query>" --scope "all"|"code"|"memory" --mode "summary"|"exact"`: Retrieves relevant context.
4.  `uv run scripts/index_file.py <file_path> &`: Indexes a specific file in the background.
