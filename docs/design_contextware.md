# Project Design: Contextware (Skill)

## 1. Overview
**Contextware** is a Gemini CLI skill that provides persistent, semantic memory for software development. It enables the agent to remember project decisions, user preferences, and high-level code purpose across sessions.

## 2. Architecture
The system is managed via **`uv`** and runs entirely locally.

*   **Dependency Management:** `pyproject.toml` (managed by `uv`).
*   **Database:** `lancedb` (Local Vector DB).
*   **Embeddings:** `fastembed` (Local, CPU-friendly embeddings).
*   **Storage Path:** `<project_root>/contextware_data/`.
*   **Execution:** All background tasks and scripts run via `uv run`.

## 3. Data Collections

### A. `facts` (The "Hippocampus")
*   **Source:** Explicitly saved by the agent using `save_memory`.
*   **Content:** Concise statements (e.g., "User prefers Pytest").
*   **Used For:** Precise retrieval of constraints and preferences.

### B. `logs` (The "Diary")
*   **Source:** Automatically logged user/agent messages.
*   **Content:** Raw text chunks.
*   **Used For:** Broad context retrieval (RAG).

### C. `code_index` (The "Map")
*   **Source:** Generated by background **headless Gemini** instances.
*   **Content:**
    *   `file_path`: Primary Key.
    *   `summary`: High-level purpose.
    *   `symbols`: List of key classes/functions (purely generative).
    *   `mtime`: Last modified timestamp for freshness checking.
*   **Used For:** Semantic search for files and structural overview.

## 4. Workflows

### Memory Capture (Explicit)
1.  User states a preference or decision.
2.  Agent calls `save_memory(fact="...")`.
3.  Skill uses `uv run` to execute a storage script that embeds and saves to `facts`.

### Codebase Indexing (Background)
1.  Agent modifies a file (e.g., `src/app.py`).
2.  Agent triggers a background process: `uv run scripts/index_file.py src/app.py &`.
3.  `index_file.py` spawns a **headless Gemini** instance using the `gemini` executable from PATH.
4.  Headless Gemini:
    *   Reads the file.
    *   Generates a JSON containing a `summary` and a list of `symbols`.
    *   Writes the result to the `code_index` collection.

### Project Crawl (Full Index)
1.  Agent calls `index_project()`.
2.  Skill triggers a single background process: `uv run scripts/crawl_project.py &`.
3.  This script spawns a **single headless Gemini agent** with the goal: "Traverse the project, read all source files, and update the `code_index` for each."
4.  The headless agent autonomously walks the directory tree, summarizing files and updating the DB as it goes.

### Retrieval (RAG)
1.  User asks: "Where do we define the data models?"
2.  Agent calls `recall_context(query="data models", scope="codebase", mode="summary"|"exact")`.
3.  The system:
    *   Searches `code_index` via vector similarity.
    *   Checks `mtime`. If stale, returns: `"[STALE] File changed recently. Please read directly."`
    *   **If mode="summary" (Default):** Returns the summary and symbol list.
    *   **If mode="exact":** Concatenates all relevant files (determined by vector similarity) and outputs them.
        *   *Constraint:* If a file is too large, the system instructs the agent to read portions of it itself.
4.  **Agent Action:** If info is missing or stale, the agent falls back to its native `read_file` tool to get full content.

## 5. Tools (Exposed to Agent)

1.  `save_memory(fact: str)`
2.  `recall_context(query: str, scope: 'all'|'code'|'memory', mode: 'summary'|'exact')`
3.  `index_project()`: Spawns a single custom headless worker to crawl the codebase and generate/update the vector database for all files.
